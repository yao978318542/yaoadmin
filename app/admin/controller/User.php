<?php
/**
 *  Created by www.kuleiman.com.
 *  User: YaoHongQiang
 *  Date: 2021/5/11   14:05
 *  description:
 */

namespace app\admin\controller;


use app\admin\AdminBase;
use think\facade\View;
use think\facade\Db;
use  app\admin\model\User as UserModel;
use app\admin\model\Auth;

class User extends AdminBase
{
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->UserModel=new UserModel();
    }
    function index(){
        $return_data=$this->UserModel->user_list();
        View::assign("list",$return_data["list"]);
        View::assign("page",$return_data["page"]);
        return View::fetch();
    }

    /**
     * 获取权限组
     */
    function auth_group(){
        $auth=new Auth();
        $data=$auth->auth_group("id,title");
        return $this->success("",["data"=>$data]);
    }
    function add(){
        $id=input("post.id/d","");
        $name=input("post.name/s","");
        $phone=input("post.phone/d","");
        $password=input("post.password/s","");
        $group=input("post.group/d","");
        $avatar=input("post.avatar/s","");
        $status=input("post.status/d","");
        $res_validate = $this->validateList(input(), 'User.UserAdd');
        if ($res_validate !== true) {
            return $res_validate;
        }else{
            if(!verify_phone($phone)){
                return $this->error("10000","手机号格式错误");
            }
            $group_info=Db::name("auth_group")->where(["status"=>1,"id"=>$group])->find();
            if(empty($group_info)){
                return $this->error("10000","请选择正确的分组");
            }
            $save_data=[
                "group_id"=>$group,
                "name"=>$name,
                "phone"=>$phone,
                "password"=>$password,
                "avatar"=>$avatar,
                "status"=>$status,
            ];
            if($id){
                Db::name("user")->where(["id"=>$id])->update($save_data);
            }else{

            }
        }
    }
}